<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>体态卫士 v7.0 - 多用户档案系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        
        .glass {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .camera-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #334155;
            transition: all 0.3s;
        }

        /* 登录页面的背景动画 */
        .login-bg {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="login-layer" class="fixed inset-0 z-50 login-bg flex flex-col items-center justify-center transition-all duration-500">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-4">
                <i class="fas fa-users text-3xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white tracking-wide">PostureGuard <span class="text-blue-500">ID</span></h1>
            <p class="text-slate-400 mt-2">个人体态健康档案管理系统</p>
        </div>

        <div class="glass p-8 rounded-2xl w-full max-w-sm">
            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">用户名 / User ID</label>
            <input type="text" id="username-input" placeholder="输入你的名字 (如: Alex)" class="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none focus:border-blue-500 transition mb-6" onkeypress="handleLoginEnter(event)">
            
            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition shadow-lg transform active:scale-95">
                进入系统
            </button>
            <p class="text-center text-xs text-slate-600 mt-4">数据将隔离存储于本地</p>
        </div>
    </div>


    <header class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center text-white font-bold">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm text-gray-200">体态卫士 v7.0</h1>
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                    <span class="text-[10px] text-slate-400" id="current-user-display">未登录</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="text-right hidden md:block">
                <p class="text-[10px] text-slate-500">个人灵敏度配置</p>
                <p class="text-xs font-mono text-blue-400 font-bold" id="user-config-info">未加载</p>
            </div>
            <div class="w-px h-8 bg-slate-700"></div>
            <button onclick="logout()" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-slate-800 transition">
                <i class="fas fa-sign-out-alt"></i> 切换用户
            </button>
        </div>
    </header>

    <div class="flex-1 flex gap-6 p-6 overflow-hidden">
        
        <main class="flex-1 flex flex-col gap-4 min-w-0">
            <div class="camera-container group" id="monitor-box">
                <video class="input_video hidden"></video>
                <canvas class="output_canvas w-full h-full object-contain"></canvas>
                
                <div id="start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-10">
                    <button onclick="startSystem()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-xl transition flex items-center gap-2">
                        <i class="fas fa-camera"></i> 启动当前用户监测
                    </button>
                </div>
                
                <div class="absolute top-4 left-4 flex gap-2">
                    <div class="bg-black/60 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-green-400" id="status-badge">
                        系统待机
                    </div>
                </div>
            </div>

            <div class="glass p-4 rounded-xl flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button onclick="calibrateUser()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg">
                        <i class="fas fa-ruler-combined mr-1"></i> 校准并保存
                    </button>
                    <div class="text-[10px] text-slate-400">
                        当前阈值: <span id="current-threshold" class="text-white font-mono">0.00</span>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-300">
                        <input type="checkbox" id="voice-toggle" class="accent-blue-500" onchange="saveUserPrefs()"> 语音
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-300">
                        <input type="checkbox" id="skeleton-toggle" class="accent-blue-500" onchange="saveUserPrefs()"> 骨骼
                    </label>
                </div>
            </div>
        </main>

        <aside class="w-80 flex flex-col gap-4 shrink-0 overflow-hidden">
            <div class="glass flex-1 rounded-xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700">
                    <h3 class="font-bold text-sm text-slate-200">
                        <i class="fas fa-file-medical-alt mr-2 text-blue-500"></i>历史档案
                    </h3>
                    <span class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-slate-300" id="history-count">0 条</span>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3" id="history-list">
                    <div class="text-center text-xs text-slate-600 mt-10">暂无该用户数据</div>
                </div>
                
                <button onclick="clearUserHistory()" class="mt-4 text-xs text-slate-500 hover:text-red-400 w-full text-center">
                    清除当前用户记录
                </button>
            </div>
        </aside>
    </div>

    <script>
        // ==========================================
        // 1. 用户管理系统 (User Management System)
        // ==========================================
        let currentUser = null;
        let userData = {
            threshold: 0.55, // 默认灵敏度
            prefs: { voice: true, skeleton: false },
            history: []
        };

        const els = {
            loginLayer: document.getElementById('login-layer'),
            usernameInput: document.getElementById('username-input'),
            currentUserDisplay: document.getElementById('current-user-display'),
            userConfigInfo: document.getElementById('user-config-info'),
            thresholdDisplay: document.getElementById('current-threshold'),
            voiceToggle: document.getElementById('voice-toggle'),
            skeletonToggle: document.getElementById('skeleton-toggle'),
            historyList: document.getElementById('history-list'),
            historyCount: document.getElementById('history-count')
        };

        function handleLoginEnter(e) {
            if(e.key === 'Enter') handleLogin();
        }

        function handleLogin() {
            const username = els.usernameInput.value.trim();
            if (!username) return alert("请输入用户名");

            currentUser = username;
            loadUserData(username);
            
            // UI 切换
            els.loginLayer.style.opacity = '0';
            setTimeout(() => {
                els.loginLayer.style.display = 'none';
            }, 500);

            // 更新 Header
            els.currentUserDisplay.innerText = `用户: ${currentUser}`;
            els.currentUserDisplay.classList.add('text-white');
            updateConfigUI();
        }

        function logout() {
            // 保存当前数据
            if(currentUser) saveUserData();
            
            // 重置状态
            currentUser = null;
            els.loginLayer.style.display = 'flex';
            setTimeout(() => els.loginLayer.style.opacity = '1', 10);
            els.usernameInput.value = '';
            
            // 停止 AI (可选)
            // location.reload(); // 最简单的重置方式是刷新页面
            window.location.reload();
        }

        // --- 核心：数据存取 ---
        function loadUserData(username) {
            const key = `pg_v7_user_${username}`;
            const stored = localStorage.getItem(key);
            
            if (stored) {
                userData = JSON.parse(stored);
                console.log(`已加载用户 ${username} 的数据`);
            } else {
                // 新用户，使用默认值
                userData = {
                    threshold: 0.55,
                    prefs: { voice: true, skeleton: false },
                    history: []
                };
                console.log(`创建新用户 ${username}`);
            }
            
            // 应用数据到界面
            els.voiceToggle.checked = userData.prefs.voice;
            els.skeletonToggle.checked = userData.prefs.skeleton;
            renderHistory();
        }

        function saveUserData() {
            if (!currentUser) return;
            const key = `pg_v7_user_${currentUser}`;
            localStorage.setItem(key, JSON.stringify(userData));
            updateConfigUI();
        }

        function saveUserPrefs() {
            userData.prefs.voice = els.voiceToggle.checked;
            userData.prefs.skeleton = els.skeletonToggle.checked;
            saveUserData();
        }

        function updateConfigUI() {
            els.userConfigInfo.innerText = `Sensitivity: ${(userData.threshold).toFixed(2)}`;
            els.thresholdDisplay.innerText = userData.threshold.toFixed(2);
        }

        // ==========================================
        // 2. AI & 校准系统
        // ==========================================
        let isSystemActive = false;
        let currentRatio = 0;
        let badFrames = 0;
        let lastSpeak = 0;

        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const ctx = canvasElement.getContext('2d');

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        pose.onResults(onResults);

        function onResults(results) {
            // 适配
            if (canvasElement.width !== videoElement.videoWidth) {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
            }

            ctx.save();
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            ctx.translate(canvasElement.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                
                // 根据用户偏好绘制骨骼
                if (userData.prefs.skeleton) {
                    drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.2)', lineWidth: 2});
                    drawLandmarks(ctx, [lm[0], lm[11], lm[12]], {color: '#3b82f6', lineWidth: 1});
                }

                checkPosture(lm);
            }
            ctx.restore();
        }

        function checkPosture(lm) {
            const nose = lm[0];
            const lSh = lm[11];
            const rSh = lm[12];
            
            // 计算颈肩比
            const shoulderWidth = Math.sqrt(Math.pow(lSh.x - rSh.x, 2) + Math.pow(lSh.y - rSh.y, 2));
            const midShY = (lSh.y + rSh.y) / 2;
            const neckDist = Math.abs(nose.y - midShY);
            
            currentRatio = neckDist / shoulderWidth;

            // 使用当前用户的阈值进行判断
            const userLimit = userData.threshold;
            const isBad = currentRatio < userLimit;

            updateStatus(isBad);
        }

        function updateStatus(isBad) {
            const badge = document.getElementById('status-badge');
            const box = document.getElementById('monitor-box');
            
            if (isBad) {
                badFrames++;
            } else {
                badFrames = 0;
                badge.innerText = "状态良好";
                badge.className = "bg-black/60 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-green-400";
                box.style.borderColor = "#334155";
            }

            if (badFrames > 40) {
                badge.innerText = "⚠️ 姿态错误";
                badge.className = "bg-red-600 px-3 py-1.5 rounded-lg text-xs font-bold text-white animate-pulse";
                box.style.borderColor = "#ef4444";
                
                if (userData.prefs.voice) {
                    const now = Date.now();
                    if (now - lastSpeak > 8000) {
                        const u = new SpeechSynthesisUtterance(`${currentUser}，请注意坐姿`);
                        window.speechSynthesis.speak(u);
                        lastSpeak = now;
                    }
                }
                
                // 模拟记录不良事件 (为了演示历史功能)
                if (badFrames === 41) { 
                    addHistoryRecord();
                }
            }
        }

        function calibrateUser() {
            if (!isSystemActive) return alert("请先启动监测");
            if (currentRatio === 0) return alert("未检测到坐姿");

            // 将当前比率的 85% 设为该用户的阈值
            const newThres = currentRatio * 0.85;
            userData.threshold = newThres;
            saveUserData(); // 保存到该用户档案
            
            alert(`校准成功！\n已为用户 [${currentUser}] 保存个性化阈值: ${newThres.toFixed(2)}`);
        }

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            isSystemActive = true;
            const camera = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 1280, height: 720
            });
            camera.start();
        }


        // ==========================================
        // 3. 历史记录系统
        // ==========================================
        function addHistoryRecord() {
            // 这里我们模拟添加一条记录（实际使用中可以是每次专注结束时添加）
            // 为了演示，每次检测到不良姿态超过一定时间，就加一条Log
            const record = {
                time: new Date().toLocaleTimeString(),
                desc: "检测到明显不良体态"
            };
            userData.history.unshift(record);
            // 限制只存最近 20 条
            if(userData.history.length > 20) userData.history.pop();
            
            saveUserData();
            renderHistory();
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            els.historyCount.innerText = `${userData.history.length} 条`;

            if (userData.history.length === 0) {
                els.historyList.innerHTML = '<div class="text-center text-xs text-slate-600 mt-10">暂无记录</div>';
                return;
            }

            userData.history.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 flex justify-between items-center";
                div.innerHTML = `
                    <span class="text-xs text-red-400 font-bold">${item.desc}</span>
                    <span class="text-[10px] text-slate-500 font-mono">${item.time}</span>
                `;
                els.historyList.appendChild(div);
            });
        }

        function clearUserHistory() {
            if(confirm(`确定清空 [${currentUser}] 的所有记录吗？`)) {
                userData.history = [];
                saveUserData();
                renderHistory();
            }
        }

    </script>
</body>
</html>
