<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“æ€å«å£« v8.0 - ç»ˆæå…¨èƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* ç»ç’ƒæ‹Ÿæ€ */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .camera-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 2px solid #334155;
            transition: all 0.3s;
        }

        .login-bg { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* æ ‡ç­¾é¡µé€‰ä¸­æ ·å¼ */
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #64748b; }
        
        .task-done span { text-decoration: line-through; color: #475569; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="login-layer" class="fixed inset-0 z-50 login-bg flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="glass p-8 rounded-2xl w-full max-w-sm text-center border-t-4 border-blue-500">
            <h1 class="text-2xl font-bold text-white mb-1">PostureGuard <span class="text-xs bg-blue-600 px-1 rounded">v8.0</span></h1>
            <p class="text-xs text-slate-400 mb-6">å…¨èƒ½å‹å¥åº·ç®¡ç†ç»ˆç«¯</p>
            
            <input type="text" id="username-input" placeholder="è¾“å…¥ç”¨æˆ·å (å¦‚: Admin)" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-3 text-white outline-none focus:border-blue-500 transition mb-4 text-center" onkeypress="handleLoginEnter(event)">
            
            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg hover:shadow-blue-500/20">
                è¿›å…¥ç³»ç»Ÿ
            </button>
        </div>
    </div>

    <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-cube text-blue-500 text-xl"></i>
            <div>
                <h1 class="font-bold text-sm text-gray-200 tracking-wide">PostureGuard</h1>
                <div class="flex items-center gap-2 text-[10px] text-slate-500">
                    <span id="current-user-display" class="text-blue-400 font-bold">æœªç™»å½•</span>
                    <span>|</span>
                    <span id="clock-display">00:00</span>
                </div>
            </div>
        </div>
        <button onclick="logout()" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 hover:bg-slate-800 px-3 py-1 rounded transition">
            <i class="fas fa-sign-out-alt"></i> é€€å‡º
        </button>
    </header>

    <div class="flex-1 flex gap-4 p-4 overflow-hidden">
        
        <main class="flex-[2] flex flex-col gap-4 min-w-0">
            <div class="camera-container group" id="monitor-box">
                <video class="input_video hidden"></video>
                <canvas class="output_canvas w-full h-full object-contain"></canvas>
                
                <div id="start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-10">
                    <button onclick="startSystem()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-xl transition flex items-center gap-2 transform hover:scale-105">
                        <i class="fas fa-play"></i> å¯åŠ¨ç›‘æµ‹
                    </button>
                </div>

                <div class="absolute top-4 left-4 flex gap-2">
                    <div class="bg-black/60 backdrop-blur px-3 py-1 rounded text-xs font-bold text-slate-300 border border-white/10" id="status-badge">
                        <i class="fas fa-circle text-[8px] text-green-500 mr-2"></i>ç³»ç»Ÿå¾…æœº
                    </div>
                </div>
            </div>

            <div class="glass p-4 rounded-xl flex justify-between items-center">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-3">
                        <button onclick="calibrateUser()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">
                            ä¸€é”®æ ¡å‡†
                        </button>
                        <span class="text-[10px] text-slate-500">å½“å‰é˜ˆå€¼: <span id="thres-disp" class="text-indigo-400">0.00</span></span>
                    </div>
                    <p class="text-[10px] text-slate-500">è¯·ä¿æŒæ ‡å‡†åå§¿åç‚¹å‡»æ ¡å‡†</p>
                </div>
                
                <div class="flex gap-4 border-l border-slate-700 pl-4">
                    <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-300 hover:text-white">
                        <input type="checkbox" id="voice-toggle" class="accent-blue-500" onchange="savePrefs()"> è¯­éŸ³
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-300 hover:text-white">
                        <input type="checkbox" id="skeleton-toggle" class="accent-blue-500" onchange="savePrefs()"> éª¨éª¼
                    </label>
                </div>
            </div>
        </main>

        <aside class="flex-1 flex flex-col glass rounded-xl overflow-hidden border border-slate-700/50">
            <div class="flex border-b border-slate-700 bg-slate-800/50">
                <button onclick="switchTab('timer')" id="tab-btn-timer" class="flex-1 py-3 text-xs font-bold text-center hover:bg-slate-700 transition tab-active">
                    <i class="fas fa-stopwatch mb-1 block text-sm"></i> ä¸“æ³¨
                </button>
                <button onclick="switchTab('tasks')" id="tab-btn-tasks" class="flex-1 py-3 text-xs font-bold text-center hover:bg-slate-700 transition tab-inactive">
                    <i class="fas fa-tasks mb-1 block text-sm"></i> ä»»åŠ¡
                </button>
                <button onclick="switchTab('history')" id="tab-btn-history" class="flex-1 py-3 text-xs font-bold text-center hover:bg-slate-700 transition tab-inactive">
                    <i class="fas fa-history mb-1 block text-sm"></i> æ¡£æ¡ˆ
                </button>
            </div>

            <div id="tab-content-timer" class="p-6 flex flex-col h-full text-center">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">ç•ªèŒ„ä¸“æ³¨é’Ÿ</h3>
                <div class="text-6xl font-mono font-bold text-white mb-2 tracking-tighter" id="timer-display">25:00</div>
                
                <div class="flex justify-center gap-2 mb-8">
                    <input type="number" id="custom-time-input" value="25" class="w-16 bg-slate-800 border border-slate-600 rounded text-center text-sm py-1">
                    <button onclick="setCustomTime()" class="text-xs bg-slate-700 px-3 rounded hover:bg-slate-600">è®¾å®š</button>
                </div>

                <button onclick="toggleTimer()" id="timer-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-900/30 mb-4">
                    å¼€å§‹ä¸“æ³¨
                </button>
                
                <p class="text-[10px] text-slate-500 mt-auto">ä¸“æ³¨æœŸé—´å°½é‡ä¿æŒå§¿æ€ç«¯æ­£</p>
            </div>

            <div id="tab-content-tasks" class="p-4 flex flex-col h-full hidden">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="task-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-xs text-white outline-none">
                    <button onclick="addTask()" class="bg-blue-600 px-3 rounded text-white text-xs"><i class="fas fa-plus"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="task-list">
                    </div>
                <div class="mt-2 pt-2 border-t border-slate-700 flex justify-between text-[10px] text-slate-500">
                    <span id="task-stats">0/0</span>
                    <button onclick="clearTasks()" class="hover:text-red-400">æ¸…ç©º</button>
                </div>
            </div>

            <div id="tab-content-history" class="p-4 flex flex-col h-full hidden">
                <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="history-list">
                    <div class="text-center text-xs text-slate-600 mt-10">æš‚æ— å†å²è®°å½•</div>
                </div>
                <button onclick="clearHistory()" class="mt-2 text-[10px] text-slate-500 hover:text-red-400 w-full text-center py-2">
                    æ¸…é™¤å½“å‰ç”¨æˆ·æ•°æ®
                </button>
            </div>
        </aside>
    </div>

    <script>
        // ============================
        // 1. å…¨å±€çŠ¶æ€ä¸ç”¨æˆ·æ•°æ®
        // ============================
        let currentUser = null;
        let userData = {
            threshold: 0.55,
            prefs: { voice: true, skeleton: false },
            tasks: [], // ä»»åŠ¡æ¸…å•
            history: [] // å†å²è®°å½•
        };

        const els = {
            loginLayer: document.getElementById('login-layer'),
            usernameInput: document.getElementById('username-input'),
            currentUserDisplay: document.getElementById('current-user-display'),
            thresDisp: document.getElementById('thres-disp'),
            voiceToggle: document.getElementById('voice-toggle'),
            skeletonToggle: document.getElementById('skeleton-toggle'),
            taskList: document.getElementById('task-list'),
            taskInput: document.getElementById('task-input'),
            historyList: document.getElementById('history-list'),
            timerDisplay: document.getElementById('timer-display'),
            timerBtn: document.getElementById('timer-btn')
        };

        // --- ç™»å½•é€»è¾‘ ---
        function handleLoginEnter(e) { if(e.key === 'Enter') handleLogin(); }

        function handleLogin() {
            const name = els.usernameInput.value.trim();
            if(!name) return;
            
            currentUser = name;
            loadUserData(name);
            
            els.loginLayer.style.opacity = '0';
            setTimeout(() => els.loginLayer.style.display = 'none', 500);
            
            els.currentUserDisplay.innerText = currentUser;
            updateUIFromData();
        }

        function logout() {
            saveData();
            location.reload();
        }

        // --- æ•°æ®å­˜å‚¨é€»è¾‘ (LocalStorage) ---
        function loadUserData(name) {
            const key = `pg_v8_${name}`;
            const stored = localStorage.getItem(key);
            if(stored) {
                userData = JSON.parse(stored);
                // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ—§æ•°æ®æ²¡æœ‰taskså­—æ®µ
                if(!userData.tasks) userData.tasks = [];
                if(!userData.history) userData.history = [];
            } else {
                // é»˜è®¤å€¼
                userData = {
                    threshold: 0.55,
                    prefs: { voice: true, skeleton: false },
                    tasks: [
                        { id: 1, text: "æ¯å·¥ä½œ45åˆ†é’Ÿå–æ°´", done: false },
                        { id: 2, text: "åšä¸€æ¬¡é¢ˆæ¤æ“", done: false }
                    ],
                    history: []
                };
            }
        }

        function saveData() {
            if(!currentUser) return;
            localStorage.setItem(`pg_v8_${currentUser}`, JSON.stringify(userData));
            updateUIFromData();
        }

        function updateUIFromData() {
            els.thresDisp.innerText = userData.threshold.toFixed(2);
            els.voiceToggle.checked = userData.prefs.voice;
            els.skeletonToggle.checked = userData.prefs.skeleton;
            renderTasks();
            renderHistory();
        }

        function savePrefs() {
            userData.prefs.voice = els.voiceToggle.checked;
            userData.prefs.skeleton = els.skeletonToggle.checked;
            saveData();
        }

        // ============================
        // 2. ä¾§è¾¹æ  Tab åˆ‡æ¢
        // ============================
        function switchTab(tabName) {
            // Hide all
            ['timer', 'tasks', 'history'].forEach(t => {
                document.getElementById(`tab-content-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).classList.replace('tab-active', 'tab-inactive');
                document.getElementById(`tab-btn-${t}`).classList.remove('border-b-2', 'border-blue-600', 'text-blue-500');
            });

            // Show target
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tabName}`);
            btn.classList.replace('tab-inactive', 'tab-active');
            btn.classList.add('border-b-2', 'border-blue-600');
        }

        // ============================
        // 3. ä»»åŠ¡æ¸…å•é€»è¾‘ (Task List)
        // ============================
        function renderTasks() {
            els.taskList.innerHTML = '';
            let doneCount = 0;
            userData.tasks.forEach((task, index) => {
                if(task.done) doneCount++;
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-2 rounded bg-slate-800/50 border border-slate-700/50 ${task.done ? 'task-done' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})" class="accent-blue-500 w-4 h-4 cursor-pointer">
                    <span class="flex-1 text-xs text-slate-200 truncate select-none">${task.text}</span>
                    <button onclick="delTask(${index})" class="text-slate-600 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
                `;
                els.taskList.appendChild(div);
            });
            document.getElementById('task-stats').innerText = `${doneCount}/${userData.tasks.length}`;
        }

        function addTask() {
            const txt = els.taskInput.value.trim();
            if(txt) {
                userData.tasks.push({ id: Date.now(), text: txt, done: false });
                els.taskInput.value = '';
                saveData();
            }
        }
        
        // ç»‘å®šå›è½¦äº‹ä»¶
        els.taskInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addTask(); });

        function toggleTask(idx) {
            userData.tasks[idx].done = !userData.tasks[idx].done;
            saveData();
        }

        function delTask(idx) {
            userData.tasks.splice(idx, 1);
            saveData();
        }
        
        function clearTasks() {
            if(confirm("æ¸…ç©ºå½“å‰ä»»åŠ¡æ¸…å•ï¼Ÿ")) {
                userData.tasks = [];
                saveData();
            }
        }

        // ============================
        // 4. ç•ªèŒ„é’Ÿé€»è¾‘ (Pomodoro)
        // ============================
        let timerId = null;
        let timeLeft = 25 * 60;
        let isRunning = false;

        function updateTimerDisp() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            els.timerDisplay.innerText = `${m}:${s}`;
        }

        function setCustomTime() {
            if(isRunning) toggleTimer(); // stop if running
            const min = parseInt(document.getElementById('custom-time-input').value) || 25;
            timeLeft = min * 60;
            updateTimerDisp();
        }

        function toggleTimer() {
            if(isRunning) {
                // Pause
                clearInterval(timerId);
                isRunning = false;
                els.timerBtn.innerText = "ç»§ç»­ä¸“æ³¨";
                els.timerBtn.classList.replace('bg-yellow-600', 'bg-blue-600');
            } else {
                // Start
                isRunning = true;
                els.timerBtn.innerText = "æš‚åœè®¡æ—¶";
                els.timerBtn.classList.replace('bg-blue-600', 'bg-yellow-600');
                
                timerId = setInterval(() => {
                    if(timeLeft > 0) {
                        timeLeft--;
                        updateTimerDisp();
                    } else {
                        // Finished
                        clearInterval(timerId);
                        isRunning = false;
                        els.timerBtn.innerText = "å¼€å§‹ä¸“æ³¨";
                        els.timerBtn.classList.replace('bg-yellow-600', 'bg-blue-600');
                        alert("ğŸ‰ ä¸“æ³¨æ—¶é—´ç»“æŸï¼Œè¯·ä¼‘æ¯ï¼");
                        addHistory("å®Œæˆä¸“æ³¨", "success");
                    }
                }, 1000);
            }
        }

        // ============================
        // 5. AI è§†è§‰ & æ ¡å‡† (Core)
        // ============================
        let systemActive = false;
        let currentRatio = 0;
        let badFrames = 0;
        let lastSpeakTime = 0;

        const video = document.getElementsByClassName('input_video')[0];
        const canvas = document.getElementsByClassName('output_canvas')[0];
        const ctx = canvas.getContext('2d');
        const badge = document.getElementById('status-badge');
        const box = document.getElementById('monitor-box');

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        pose.onResults(onResults);

        function onResults(results) {
            if(canvas.width !== video.videoWidth) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                if(userData.prefs.skeleton) {
                    drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.2)', lineWidth: 2});
                    drawLandmarks(ctx, [lm[0], lm[11], lm[12]], {color: '#3b82f6', lineWidth: 1});
                }
                checkPosture(lm);
            }
            ctx.restore();
        }

        function checkPosture(lm) {
            const nose = lm[0];
            const shL = lm[11];
            const shR = lm[12];
            
            const shWidth = Math.sqrt(Math.pow(shL.x - shR.x, 2) + Math.pow(shL.y - shR.y, 2));
            const midY = (shL.y + shR.y) / 2;
            const neckDist = Math.abs(nose.y - midY);
            
            currentRatio = neckDist / shWidth;
            
            // Logic
            if(currentRatio < userData.threshold) {
                badFrames++;
            } else {
                badFrames = 0;
                badge.innerHTML = '<i class="fas fa-check text-[8px] text-green-500 mr-2"></i>çŠ¶æ€è‰¯å¥½';
                badge.className = "bg-black/60 backdrop-blur px-3 py-1 rounded text-xs font-bold text-green-400 border border-green-500/30";
                box.style.borderColor = "#334155";
            }

            if(badFrames > 50) { // ~1.5 sec
                badge.innerHTML = '<i class="fas fa-exclamation-triangle text-[8px] text-white mr-2"></i>å§¿æ€å¼‚å¸¸';
                badge.className = "bg-red-600 px-3 py-1 rounded text-xs font-bold text-white animate-pulse border border-red-400";
                box.style.borderColor = "#ef4444";
                
                if(userData.prefs.voice) {
                    const now = Date.now();
                    if(now - lastSpeakTime > 8000) {
                        const u = new SpeechSynthesisUtterance("è¯·æ³¨æ„åå§¿");
                        window.speechSynthesis.speak(u);
                        lastSpeakTime = now;
                    }
                }
                
                // Log event rarely
                if(badFrames === 51) {
                    addHistory("å§¿æ€ä¸è‰¯è­¦å‘Š", "warn");
                }
            }
        }

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            const camera = new Camera(video, {
                onFrame: async () => { await pose.send({image: video}); },
                width: 1280, height: 720
            });
            camera.start();
        }

        function calibrateUser() {
            if(currentRatio === 0) return alert("æœªæ£€æµ‹åˆ°åå§¿ï¼Œè¯·æ­£å¯¹æ‘„åƒå¤´");
            userData.threshold = currentRatio * 0.85;
            saveData();
            alert(`âœ… æ ¡å‡†æˆåŠŸï¼\nå·²ä¸º [${currentUser}] è®¾å®šé˜ˆå€¼: ${userData.threshold.toFixed(2)}`);
        }

        // --- å†å²è®°å½• ---
        function addHistory(text, type) {
            const item = { 
                time: new Date().toLocaleTimeString(), 
                text: text, 
                type: type // 'success' or 'warn'
            };
            userData.history.unshift(item);
            if(userData.history.length > 30) userData.history.pop();
            saveData();
            renderHistory(); // åªæœ‰åœ¨å†å²Tabå¯è§æ—¶æ¸²æŸ“ä¹Ÿè¡Œï¼Œè¿™é‡Œç›´æ¥æ¸²æŸ“
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            if(!userData.history.length) {
                els.historyList.innerHTML = '<div class="text-center text-xs text-slate-600 mt-10">æš‚æ— è®°å½•</div>';
                return;
            }
            userData.history.forEach(h => {
                const color = h.type === 'success' ? 'text-green-400' : 'text-red-400';
                const div = document.createElement('div');
                div.className = "flex justify-between text-xs p-2 border-b border-slate-800";
                div.innerHTML = `
                    <span class="${color} font-bold">${h.text}</span>
                    <span class="text-slate-500 font-mono">${h.time}</span>
                `;
                els.historyList.appendChild(div);
            });
        }
        
        function clearHistory() {
            if(confirm("æ¸…é™¤è®°å½•ï¼Ÿ")) {
                userData.history = [];
                saveData();
            }
        }

        // æ—¶é’Ÿ
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);

    </script>
</body>
</html>